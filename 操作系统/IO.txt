
输入和输出都是针对cpu的：数据输入/输出给cpu。磁盘可以输入也可以输出。绝大部分输入输出设备都是以【字节】为传输单位

IO设备分类
块设备：每个块为 512-65536 字节。块有结构，可寻址（每个块有自己的地址）。每个块能独立于其他块而读写。常见设备如硬盘，光盘
字符设备：以字符为单位发送或接收【字符流】。没有块结构，不可寻址，也没有寻道操作，通过【中断】表示传输完成。常见设备如打印机，网络接口，鼠标
还有其他，如时钟（按预先规定好的时间间隔产生中断）

IO设备的构成
机械部件：执行具体的操作，比如鼠标的按钮
电子部件：即IO控制器、设备控制器、适配器，即芯片，是CPU和硬件的桥梁（CPU不能直接控制IO设备硬件）。主要作用：接收CPU的命令，向CPU报告设备状态，数据交换，地址识别

IO控制器的组成
1.CPU与控制器间的接口
CPU通过地址线/控制线将设备地址、命令传给IO逻辑，IO逻辑从设备读取数据放在【数据寄存器】中，将设备的状态放在【状态寄存器】中，cpu从中读数据和状态
2.IO逻辑（核心）
3.控制器与设备间的接口
一个控制器可以控制多个设备。比如多个磁盘并联。每一个设备都有对应自己的【数据寄存器】【状态寄存器】【控制寄存器】（这些寄存器其实是高速缓存）
该接口通常很底层，比如SATA，磁盘每个磁道有200w个扇区，每个扇区512字节
从驱动器出来的是一个串行的bit流，以【前导符，包含柱面数，扇区号，扇区大小等】开始，然后是4096位，最后是校验和（错误校正码，ECC）。控制器的任务是把串行的bit流转换为字节块并校验，成功后复制到主存

CPU和控制寄存器/数据缓冲区的通信方式
方式一：统一编址。将上面3中寄存器也视为内存，为它们分配内存地址，是连续的，cpu操作内存和操作寄存器就是一回事了。这种系统称为【内存映射IO】
方式二：独立编址。为每个寄存器分配一个【IO端口号】，所有的IO端口号形成一个【IO端口空间】，且普通的用户程序无法访问。内存地址空间和IO地址空间是不同的，调用的指令也不同。早期计算机都是这种方式
还有一种混合实现：具有内存映射IO的数据缓冲区，而控制寄存器有单独的IO端口

IO控制方式
即IO控制器如何实现对IO设备的控制（读写）
1.程序控制
读：cpu把指令通过地址线，控制线传给IO逻辑，随后轮询（忙等、阻塞）【状态寄存器】。IO逻辑从设备读取数据，写入数据寄存器，然后更新状态寄存器。cpu检测到状态改变，从数据寄存器读取数据。数据流向为：设备->cpu->主存。（cpu内部也有寄存器）
写：cpu把指令通过地址线，控制线传给IO逻辑，IO逻辑从数据寄存器读取数据并写入设备，然后更新状态寄存器。cpu轮询状态寄存器，并更新数据寄存器
每次读写一个字（通过数据总线，即数据总线有多宽，即位宽，则字就有多长。常见字长为32位或64位）
这种方式最大问题是cpu要轮询状态寄存器，效率低
2.中断驱动
在IO操作的前后干预，以读为例：cpu发送指令后，IO逻辑发出一个中断信号，cpu不再忙等，将应用进程阻塞（运行其他进程）。IO逻辑完成后，再次发出一个中断信号，通知cpu。cpu检查状态寄存器，确认无误再读取数据寄存器
仍是每次读写一个字，数据流向不变
缺点是操作的数据一般远大于字长，因此频繁发生中断
3.DMA
这种方式本质上是程序控制，只是由DMA控制器（而非CPU）做工作。这种方式需要特殊的硬件（DMA控制器），但是CPU可以获得自由从而在IO期间做其他事。传输单位是块（而非字），常见为512/1024等字节。数据是从设备到内存（即不经过cpu）
DMA控制器一般包含：
数据寄存器（DR）
内存地址寄存器（MAR）
计数寄存器（DC）
控制寄存器（CR）
经典流程如下：cpu发出读命令，并收到DMA的中断信号。DMA更新控制寄存器状态为忙，从设备读数据，写入数据寄存器（同样是通过数据总线），满了后刷到内存（通过内存地址寄存器获取要写入的内存地址），并更新计数寄存器。每次操作一个块，但读取设备一般是几个字节的读取，因此会读取多次。当计数寄存器的计数达到一个块的大小，则发出中断，通知CPU
如果读取多个块，若它们是连续的，则不会发出中断，直到【连续】的块读完；若离散，则每个块都要执行上面的流程（两次中断）
DMA的方式和中断驱动相比，最大的优点是显著减少了中断次数。但是DMA控制器一般比CPU慢很多，如果CPU比较空闲，则采取中断甚至程序控制会更好，另外DMA设备也有成本，在低端设备（嵌入式）中去除DMA也很重要
4.通道控制
通道是专门处理IO的处理机，独立于cpu。与DMA类似，设备和内存直接交互。一个通道可以管理多个设备
cpu发出指令给通道，通道发出中断请求，执行专门的通道程序，每次读写一组块
缺点是成本高

IO软件层次
用户级IO软件
与设备无关的操作系统软件
与硬件相关的设备驱动程序：安装在硬件中的软件，被操作系统调用
中断处理程序：中断发生时，中断处理程序要处理它必须要的全部工作，完成后让先前被阻塞的驱动程序能够继续运行
（硬件）
其中中间三个合称为IO【核心】子系统

IO核心子系统
主要功能如下（这些都是在操作系统实现的）
IO调度：和线程的调度类似
设备保护：操作系统把设备当作文件，文件有【文件控制块】，操作系统按照【管理文件】的方式管理设备
假脱机技术
设备分配与回收
缓冲区管理
